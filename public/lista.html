<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">document.oncontextmenu = function(){return false;}</script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>One Box - Gesti√≥n de Reservas</title>
    <style>
        .select-restaurar {
            background: #313244;
            color: white;
            border: 1px solid #45475a;
            padding: 5px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-texto">üõí Area de Reservas</div>
        <a href="panel.html" class="btn-header">üè† INICIO</a>
    </header>

    <div class="contenedor-lista">    
        <div class="encabezado-total">
            <h2 style="margin-bottom: 20px; text-align: left;">üìã Estado de Reservas</h2>

            <div class="fila-controles">
                <div class="filtros-estados">
                    <button class="btn-filtro active" onclick="filtrarEstado('En Tr√°nsito')">En Tr√°nsito</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Pendiente de Retiro')">Pendiente de Retiro</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Finalizado')">Finalizado</button>
                    <button id="btnTabEliminados" class="btn-filtro" onclick="filtrarEstado('Eliminados')" style="display: none; border-color: #f38ba8; color: #f38ba8;">üóëÔ∏è Eliminados</button>
                </div>
                <input type="text" id="buscador" placeholder="üîç Buscar cliente, c√≥digo o local..." style="margin: 0; width: 300px;">
            </div>
        </div>

        <div class="tabla-scroll-container">
            <table id="tablaReservas">
                <thead>
                    <tr id="encabezadoTabla"></tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="javascript:void(0)" onclick="abrirSoporte()">Soporte</a>
        </div>
        <img src="./img/Ob_Logo.png" alt="One Box Logo" class="footer-logo">
        <p>&copy; 2026 One Box. Todos los derechos reservados.</p>
        <div class="footer-version">v1.3.5</div> 
    </footer>

    <div id="modalEditar" class="modal-overlay" style="display: none;">
        <div class="modal-caja modal-ancho-editar">
            <h3 style="color: #fab387; margin-bottom: 20px; text-align: center;">üìù Editar Reserva</h3>
            <input type="hidden" id="editId">
            <form id="formEditar" class="grid-editar">
                <div class="col-editar">
                    <label>Nombre Cliente:</label>
                    <input type="text" id="editNombre">
                    <label>Tel√©fono:</label>
                    <input type="text" id="editTel">
                </div>
                <div class="col-editar">
                    <label>C√≥digo Producto:</label>
                    <input type="text" id="editCodigo">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="editDesc">
                </div>
                <div class="col-editar">
                    <label>Total Reserva ($):</label>
                    <input type="number" id="editTotal">
                </div>
            </form>
            <div class="modal-botones" style="margin-top: 30px;">
                <button onclick="guardarEdicion()" class="btn-azul">GUARDAR CAMBIOS</button>
                <button onclick="cerrarEditar()" class="btn-secundario">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modalFirma" class="modal-overlay">
        <div class="modal-caja">
            <h3 id="tituloFirma" style="color: #89b4fa;">‚ö†Ô∏è Confirmaci√≥n</h3>
            <p id="mensajeFirma" style="margin-bottom: 20px;"></p>
            <div id="contenedorInputFirma" style="margin-bottom: 20px; width: 100%;">
                <label style="color: #cdd6f4; display: block; margin-bottom: 10px; text-align: left;">Nombre del responsable:</label>
                <input type="text" id="inputNombreResponsable" placeholder="Su nombre aqu√≠..." 
                       style="background: #313244; color: white; border: 1px solid #45475a; padding: 12px; width: 100%; border-radius: 6px; box-sizing: border-box;">
            </div>
            <div class="modal-botones" style="width: 100%;">
                <button id="modalAceptar" class="btn-azul">CONFIRMAR</button>
                <button onclick="cerrarModalFirma()" class="btn-secundario">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modalAviso" class="modal-overlay">
        <div class="modal-caja" id="bordeModal">
            <h3 id="tituloAviso"></h3>
            <p id="textoAviso" style="color: #fff; margin-bottom: 20px;"></p>
            <div class="modal-botones">
                <button onclick="cerrarAviso()" class="btn-azul" id="btnColorAviso">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="modalQR" class="modal-overlay">
        <div class="modal-caja" style="max-width: 400px; text-align: center;">
            <h3 style="color: #25d366; margin-bottom: 10px;">üì≤ Env√≠o de Aviso</h3>
            <div style="background: white; padding: 15px; border-radius: 10px; display: inline-block; margin-bottom: 20px;">
                <canvas id="canvasQR"></canvas>
            </div>
            <div class="modal-botones" style="width: 100%;">
                <button onclick="cerrarModalQR()" class="btn-azul">CERRAR Y FINALIZAR</button>
            </div>
        </div>
    </div>

<script>
    let estadoActualFiltrado = 'En Tr√°nsito';
    let reservasCargadas = [];

    if (!sessionStorage.getItem('usuario_nombre')) window.location.href = 'index.html';

    function mostrarAviso(titulo, mensaje, esError = true) {
        const modal = document.getElementById('modalAviso');
        document.getElementById('tituloAviso').textContent = titulo;
        document.getElementById('textoAviso').textContent = mensaje;
        const color = esError ? '#f38ba8' : '#a6e3a1';
        document.getElementById('tituloAviso').style.color = color;
        document.getElementById('bordeModal').style.borderColor = color;
        document.getElementById('btnColorAviso').style.backgroundColor = color;
        modal.style.display = 'flex';
    }

    function cerrarAviso() { document.getElementById('modalAviso').style.display = 'none'; }
    function cerrarEditar() { document.getElementById('modalEditar').style.display = 'none'; }
    function cerrarModalFirma() { document.getElementById('modalFirma').style.display = 'none'; document.getElementById('inputNombreResponsable').value = ''; }
    function cerrarModalQR() { document.getElementById('modalQR').style.display = 'none'; cargarReservas(); }

    function actualizarEncabezados() {
        const header = document.getElementById('encabezadoTabla');
        const rol = sessionStorage.getItem('usuario_rol');
        let columnas = `<th>ID</th><th>Fecha</th><th>Cliente</th><th>Email</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant.</th><th>Total</th><th>Estado</th>`;
        
        if (estadoActualFiltrado === 'En Tr√°nsito') columnas += `<th>Origen</th><th>Operador</th>`;
        else if (estadoActualFiltrado === 'Pendiente de Retiro') columnas += `<th>Ingreso Local</th>`;
        else if (estadoActualFiltrado === 'Finalizado') columnas += `<th>Cierre</th>`;
        else if (estadoActualFiltrado === 'Eliminados') columnas += `<th>Ingres√≥</th><th>Finaliz√≥</th><th>Operador</th>`;
        
        if (rol === 'admin') columnas += `<th>Local Op.</th>`;
        columnas += `<th>Acciones</th>`;
        header.innerHTML = columnas;
    }

    function filtrarEstado(estado) {
        estadoActualFiltrado = estado;
        document.querySelectorAll('.btn-filtro').forEach(btn => btn.classList.toggle('active', btn.textContent.trim().includes(estado)));
        actualizarEncabezados();
        cargarReservas(document.getElementById('buscador').value);
    }

    function cargarReservas(busqueda = '') {
        const tabla = document.getElementById('tablaCuerpo');
        const sucursal = sessionStorage.getItem('usuario_sucursal');
        const rol = sessionStorage.getItem('usuario_rol'); 
        fetch(`/reservas?q=${busqueda}&sucursal=${sucursal}&rol=${rol}`)
            .then(res => res.json())
            .then(datos => {
                reservasCargadas = datos; 
                tabla.innerHTML = '';
                const filtrados = datos.filter(item => {
                    if (estadoActualFiltrado === 'Eliminados') return item.borrado === 1;
                    if (estadoActualFiltrado === 'Finalizado') return (item.estado === 'Retirado' || item.estado === 'Cancelado') && item.borrado === 0;
                    return item.estado === estadoActualFiltrado && item.borrado === 0;
                });
                if(filtrados.length === 0) {
                    tabla.innerHTML = `<tr><td colspan="25" style="text-align:center; padding: 20px;">No hay registros.</td></tr>`;
                    return;
                }
                filtrados.forEach(item => {
                    const fReg = new Date(item.fecha_registro).toLocaleDateString('es-AR');
                    const fIng = item.fecha_ingreso ? new Date(item.fecha_ingreso).toLocaleDateString('es-AR') : '---';
                    const fCie = item.fecha_cierre ? new Date(item.fecha_cierre).toLocaleDateString('es-AR') : '---';
                    let fila = `<tr><td>#${item.id}</td><td style="font-size: 0.85em;">${fReg}</td><td><strong>${item.cliente_nombre}</strong><br><small>${item.cliente_telefono}</small></td><td><small>${item.cliente_email || '---'}</small></td><td><code>${item.prod_codigo}</code></td><td style="font-size: 0.85em;">${item.descripcion}</td><td style="text-align:center">${item.prod_cantidad}</td><td style="font-weight:bold">$${item.total_reserva}</td><td><span class="badge">${item.estado}</span></td>`;
                    
                    if (estadoActualFiltrado === 'En Tr√°nsito') fila += `<td><strong>${item.sucursal_nombre}</strong></td><td>${item.operador_nombre}</td>`;
                    else if (estadoActualFiltrado === 'Pendiente de Retiro') fila += `<td><strong>${item.responsable_recibo || '---'}</strong><br><small>${fIng}</small></td>`;
                    else if (estadoActualFiltrado === 'Finalizado') fila += `<td><strong>${item.responsable_finalizado || '---'}</strong><br><small>${fCie}</small></td>`;
                    else if (estadoActualFiltrado === 'Eliminados') fila += `<td>${item.responsable_recibo || '---'}</td><td>${item.responsable_finalizado || '---'}</td><td>${item.operador_nombre || '---'}</td>`;
                    
                    if (rol === 'admin') fila += `<td style="color: #89b4fa; font-weight: bold;">${item.local_origen || 'S/D'}</td>`;
                    fila += `<td><div class="celda-acciones">${getBotonesAccion(item)}</div></td></tr>`;
                    tabla.innerHTML += fila;
                });
            });
    }

    function getBotonesAccion(item) {
        const rol = sessionStorage.getItem('usuario_rol');
        let botones = "";
        
        if (item.borrado === 1) {
            if (rol === 'admin' || rol === 'encargado') {
                botones += `
                    <select onchange="restaurarReserva(${item.id}, this.value)" class="select-restaurar">
                        <option value="">Restaurar a...</option>
                        <option value="En Tr√°nsito">En Tr√°nsito</option>
                        <option value="Pendiente de Retiro">Pendiente de Retiro</option>
                    </select>`;
                if (rol === 'admin') {
                    botones += `<button class="btn-borrar" onclick="confirmarEliminarDefinitivo(${item.id})">ELIMINAR DB</button>`;
                }
                return botones;
            }
            return "";
        }

        if (item.estado === 'En Tr√°nsito') {
            botones += `<button class="btn-azul" onclick="cambiarEstadoConFirma(${item.id}, 'Pendiente de Retiro', '¬øConfirmar ingreso al local?', true)">CONFIRMAR INGRESO</button>`;
            if (rol === 'admin' || rol === 'encargado') {
                const itemData = JSON.stringify(item).replace(/'/g, "&apos;");
                botones += `<button class="btn-azul" style="background:#f39c12; margin-left:5px;" onclick='abrirModalEditar(${itemData})'>EDITAR</button>`;
            }
        } else if (item.estado === 'Pendiente de Retiro') {
            botones += `<button class="btn-azul" style="background:#a6e3a1; color:#1e1e2e;" onclick="cambiarEstadoConFirma(${item.id}, 'Retirado', '¬øConfirmar entrega al cliente?')">RETIRADO</button>`;
            botones += `<button class="btn-borrar" style="margin-left:5px;" onclick="cambiarEstadoConFirma(${item.id}, 'Cancelado', '¬øDesea cancelar esta reserva?')">CANCELADO</button>`;
        } else if (item.estado === 'Retirado' || item.estado === 'Cancelado') {
            if (rol === 'admin') {
                botones += `<button class="btn-borrar" onclick="abrirModalBorradoLogico(${item.id})">BORRAR</button>`;
            }
        }
        return botones;
    }

    function restaurarReserva(id, nuevoEstado) {
        if (!nuevoEstado) return;
        const btnAceptar = document.getElementById('modalAceptar');
        btnAceptar.onclick = async function() {
            const res = await fetch(`/reservas/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    estado: nuevoEstado, 
                    borrado: 0,
                    responsable: sessionStorage.getItem('usuario_nombre') 
                })
            });
            if(res.ok) {
                cerrarModalFirma();
                cargarReservas();
                mostrarAviso('‚úÖ Recuperada', 'Reserva restaurada con √©xito.', false);
            }
        };
        abrirModalFirma(`¬øRecuperar reserva y pasar a estado "${nuevoEstado}"?`, false, null);
    }

    function abrirModalBorradoLogico(id) {
        const btnAceptar = document.getElementById('modalAceptar');
        btnAceptar.onclick = async function() {
            const res = await fetch(`/reservas/${id}`, { method: 'DELETE' });
            if(res.ok) {
                cerrarModalFirma();
                cargarReservas();
                mostrarAviso('‚úÖ √âxito', 'Reserva movida a Eliminados.', false);
            }
        };
        abrirModalFirma("¬øDeseas mover esta reserva a la papelera?", false, null);
    }

    async function confirmarEliminarDefinitivo(id) {
        if (confirm("‚ö†Ô∏è ¬øTRASPASAR A HIST√ìRICO Y BORRAR DE TABLA ACTIVA? Esta acci√≥n no se puede deshacer.")) {
            const res = await fetch(`/admin/reservas-eliminar/${id}`, { method: 'DELETE' });
            if (res.ok) {
                cargarReservas();
                mostrarAviso('‚úÖ Archivado', 'La reserva se movi√≥ a la tabla borrados_definitivos.', false);
            }
        }
    }

    function cambiarEstadoConFirma(id, nuevoEstado, preg, activarQR = false) {
        const btnAceptar = document.getElementById('modalAceptar');
        btnAceptar.onclick = function() {
            const resp = document.getElementById('inputNombreResponsable').value.trim();
            if (!resp) return alert("Ingrese su nombre");
            
            fetch(`/reservas/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado, responsable: resp })
            }).then(res => { 
                if(res.ok) { 
                    cerrarModalFirma();
                    if(activarQR) mostrarQR(id);
                    else { cargarReservas(); }
                } 
            });
        };
        abrirModalFirma(preg, true, null);
    }

    function abrirModalFirma(pregunta, requiereInput, accionOpcional) {
        document.getElementById('mensajeFirma').textContent = pregunta;
        document.getElementById('contenedorInputFirma').style.display = requiereInput ? 'block' : 'none';
        document.getElementById('modalFirma').style.display = 'flex';
        if(accionOpcional) document.getElementById('modalAceptar').onclick = accionOpcional;
    }

    function abrirModalEditar(item) {
        document.getElementById('editId').value = item.id;
        document.getElementById('editNombre').value = item.cliente_nombre;
        document.getElementById('editTel').value = item.cliente_telefono;
        document.getElementById('editCodigo').value = item.prod_codigo;
        document.getElementById('editDesc').value = item.descripcion;
        document.getElementById('editTotal').value = item.total_reserva;
        document.getElementById('modalEditar').style.display = 'flex';
    }

    function guardarEdicion() {
        const id = document.getElementById('editId').value;
        const data = {
            cliente_nombre: document.getElementById('editNombre').value,
            cliente_telefono: document.getElementById('editTel').value,
            prod_codigo: document.getElementById('editCodigo').value,
            descripcion: document.getElementById('editDesc').value,
            total_reserva: document.getElementById('editTotal').value
        };
        fetch(`/reservas/${id}/editar`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => { cerrarEditar(); cargarReservas(); });
    }

    function mostrarQR(id) {
        const item = reservasCargadas.find(r => r.id == id);
        if (!item) return;
        let tel = item.cliente_telefono.replace(/\D/g, '');
        if (tel.startsWith('0')) tel = tel.substring(1);
        if (!tel.startsWith('549')) tel = '549' + tel;
        const msg = `Hola ${item.cliente_nombre}, tu reserva "${item.descripcion}" ya est√° disponible para retirar.`;
        const url = `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
        document.getElementById('modalQR').style.display = 'flex';
        setTimeout(() => { QRCode.toCanvas(document.getElementById('canvasQR'), url, { width: 240, margin: 2 }); }, 200);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rol = sessionStorage.getItem('usuario_rol');
        if (rol === 'admin' || rol === 'encargado') document.getElementById('btnTabEliminados').style.display = 'inline-block';
        actualizarEncabezados();
        cargarReservas();
    });

    document.getElementById('buscador').addEventListener('input', (e) => cargarReservas(e.target.value));
</script>
</body>
</html>