<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">document.oncontextmenu = function(){return false;}</script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Gesti√≥n de Reservas</title>
    <style>
        .select-restaurar {
            background: #313244;
            color: white;
            border: 1px solid #45475a;
            padding: 5px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            cursor: pointer;
        }
        .grid-editar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            text-align: left;
        }
        .col-editar label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        .col-editar input, .col-editar textarea {
            width: 100%;
            margin-bottom: 10px;
            background: #1e1e2e;
            border: 1px solid #45475a;
            color: white;
            padding: 8px;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-texto">üõí Area de Reservas</div>
        <a href="panel.html" class="btn-header">üè† INICIO</a>
    </header>

    <div class="contenedor-lista">    
        <div class="encabezado-total">
            <h2 style="margin-bottom: 20px; text-align: left;">üìã Estado de Reservas</h2>

            <div class="fila-controles">
                <div class="filtros-estados">
                    <button class="btn-filtro active" onclick="filtrarEstado('En Tr√°nsito')">En Tr√°nsito</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Pendiente de Retiro')">Pendiente de Retiro</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Finalizado')">Finalizado</button>
                    <button id="btnTabEliminados" class="btn-filtro" onclick="filtrarEstado('Eliminados')" style="display: none; border-color: #f38ba8; color: #f38ba8;">üóëÔ∏è Eliminados</button>
                </div>
                <input type="text" id="buscador" placeholder="üîç Buscar cliente, c√≥digo o local..." style="margin: 0; width: 300px;">
            </div>
        </div>

        <div class="tabla-scroll-container">
            <table id="tablaReservas">
                <thead>
                    <tr id="encabezadoTabla"></tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
    </div>

    <div id="modalEditar" class="modal-overlay" style="display: none;">
        <div class="modal-caja modal-ancho-editar" style="max-width: 850px;">
            <h3 style="color: #fab387; margin-bottom: 20px; text-align: center;">üìù Editar Reserva</h3>
            <input type="hidden" id="editId">
            <form id="formEditar" class="grid-editar">
                <div class="col-editar">
                    <label style="color: #4a90e2; font-weight: bold;">üë§ Cliente</label>
                    <label>Nombre:</label>
                    <input type="text" id="editNombre">
                    <label>Tel√©fono:</label>
                    <input type="text" id="editTel">
                    <label>Email:</label>
                    <input type="email" id="editEmail">
                </div>
                <div class="col-editar">
                    <label style="color: #4a90e2; font-weight: bold;">üì¶ Producto</label>
                    <label>C√≥digo:</label>
                    <input type="text" id="editCodigo" onblur="buscarProductoEditar()">
                    <label>Descripci√≥n:</label>
                    <textarea id="editDesc" readonly style="background: #313244; height: 60px;"></textarea>
                    <label>Cantidad:</label>
                    <input type="number" id="editCant" oninput="calcularTotalEditar()">
                </div>
                <div class="col-editar">
                    <label style="color: #4a90e2; font-weight: bold;">üí∞ Valores</label>
                    <label>Precio Unitario:</label>
                    <input type="number" id="editPrecioU" readonly style="background: #313244;">
                    <label>Total Reserva ($):</label>
                    <input type="number" id="editTotal" readonly style="background: #313244; font-weight: bold; color: #a6e3a1;">
                </div>
            </form>
            <div class="modal-botones" style="margin-top: 30px;">
                <button onclick="guardarEdicion()" class="btn-azul">GUARDAR CAMBIOS</button>
                <button onclick="cerrarEditar()" class="btn-secundario">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modalFirma" class="modal-overlay">
        <div class="modal-caja">
            <h3 id="tituloFirma" style="color: #89b4fa;">‚ö†Ô∏è Confirmaci√≥n</h3>
            <p id="mensajeFirma" style="margin-bottom: 20px;"></p>
            <div id="contenedorInputFirma" style="margin-bottom: 20px; width: 100%;">
                <label style="color: #cdd6f4; display: block; margin-bottom: 10px; text-align: left;">Nombre del responsable:</label>
                <input type="text" id="inputNombreResponsable" placeholder="Su nombre aqu√≠..." 
                       style="background: #313244; color: white; border: 1px solid #45475a; padding: 12px; width: 100%; border-radius: 6px; box-sizing: border-box;">
            </div>
            <div class="modal-botones" style="width: 100%;">
                <button id="modalAceptar" class="btn-azul">CONFIRMAR</button>
                <button onclick="cerrarModalFirma()" class="btn-secundario">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modalAviso" class="modal-overlay">
        <div class="modal-caja" id="bordeModal">
            <h3 id="tituloAviso"></h3>
            <p id="textoAviso" style="color: #fff; margin-bottom: 20px;"></p>
            <div class="modal-botones">
                <button onclick="cerrarAviso()" class="btn-azul" id="btnColorAviso">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="modalQR" class="modal-overlay">
        <div class="modal-caja" style="max-width: 400px; text-align: center;">
            <h3 style="color: #25d366; margin-bottom: 10px;">üì≤ Env√≠o de Aviso</h3>
            <div style="background: white; padding: 15px; border-radius: 10px; display: inline-block; margin-bottom: 20px;">
                <canvas id="canvasQR"></canvas>
            </div>
            <div class="modal-botones" style="width: 100%;">
                <button onclick="cerrarModalQR()" class="btn-azul">CERRAR Y FINALIZAR</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-creador-container">
            <span class="texto-creado">Creado por:</span>
            <img src="./img/New_Logo_OB.png" alt="One Box Logo" class="footer-logo">
        </div>

        <div class="footer-centro">
            <div class="footer-links">
                <a href="soporte.html" onclick="registrarOrigenSoporte()">Soporte</a>
            </div>
            <p>&copy; 2026 Tu Sistema de Reservas. Todos los derechos reservados.</p>
        </div>

        <div class="footer-version-container">
            <div class="footer-version">v4.5.0</div>
        </div>
    </footer>

    <script>
        function registrarOrigenSoporte() {
            // Obtenemos el nombre del archivo actual (ej: login.html)
            const paginaActual = window.location.pathname.split('/').pop() || 'Inicio';
            sessionStorage.setItem('origen_soporte', paginaActual);
        }
    </script>

<script>
    let estadoActualFiltrado = 'En Tr√°nsito';
    let reservasCargadas = [];

    if (!sessionStorage.getItem('usuario_nombre')) window.location.href = 'index.html';

    function mostrarAviso(titulo, mensaje, esError = true) {
        const modal = document.getElementById('modalAviso');
        document.getElementById('tituloAviso').textContent = titulo;
        document.getElementById('textoAviso').textContent = mensaje;
        const color = esError ? '#f38ba8' : '#a6e3a1';
        document.getElementById('tituloAviso').style.color = color;
        document.getElementById('bordeModal').style.borderColor = color;
        document.getElementById('btnColorAviso').style.backgroundColor = color;
        modal.style.display = 'flex';
    }

    function cerrarAviso() { document.getElementById('modalAviso').style.display = 'none'; }
    function cerrarEditar() { document.getElementById('modalEditar').style.display = 'none'; }
    function cerrarModalFirma() { document.getElementById('modalFirma').style.display = 'none'; document.getElementById('inputNombreResponsable').value = ''; }
    function cerrarModalQR() { document.getElementById('modalQR').style.display = 'none'; cargarReservas(); }

    function actualizarEncabezados() {
        const header = document.getElementById('encabezadoTabla');
        const rol = sessionStorage.getItem('usuario_rol');
        let columnas = `<th>ID</th><th>Fecha</th><th>Cliente</th><th>Email</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant.</th><th>Total</th><th>Estado</th>`;
        
        if (estadoActualFiltrado === 'En Tr√°nsito') columnas += `<th>Origen (Contacto)</th><th>Operador</th>`;
        else if (estadoActualFiltrado === 'Pendiente de Retiro') columnas += `<th>Ingreso Local</th>`;
        else if (estadoActualFiltrado === 'Finalizado') columnas += `<th>Cierre</th>`;
        else if (estadoActualFiltrado === 'Eliminados') columnas += `<th>Ingres√≥</th><th>Finaliz√≥</th><th>Operador</th>`;
        
        if (rol === 'admin') columnas += `<th>Local Op.</th>`;
        columnas += `<th>Acciones</th>`;
        header.innerHTML = columnas;
    }

    function filtrarEstado(estado) {
        estadoActualFiltrado = estado;
        document.querySelectorAll('.btn-filtro').forEach(btn => btn.classList.toggle('active', btn.textContent.trim().includes(estado)));
        actualizarEncabezados();
        cargarReservas(document.getElementById('buscador').value);
    }

    function cargarReservas(busqueda = '') {
        const tabla = document.getElementById('tablaCuerpo');
        const sucursal = sessionStorage.getItem('usuario_sucursal');
        const rol = sessionStorage.getItem('usuario_rol'); 
        fetch(`/reservas?q=${busqueda}&sucursal=${sucursal}&rol=${rol}`)
            .then(res => res.json())
            .then(datos => {
                reservasCargadas = datos; 
                tabla.innerHTML = '';
                const filtrados = datos.filter(item => {
                    if (estadoActualFiltrado === 'Eliminados') return item.borrado === 1;
                    if (estadoActualFiltrado === 'Finalizado') return (item.estado === 'Retirado' || item.estado === 'Cancelado') && item.borrado === 0;
                    return item.estado === estadoActualFiltrado && item.borrado === 0;
                });
                if(filtrados.length === 0) {
                    tabla.innerHTML = `<tr><td colspan="25" style="text-align:center; padding: 20px;">No hay registros.</td></tr>`;
                    return;
                }
                filtrados.forEach(item => {
                    const fReg = new Date(item.fecha_registro).toLocaleDateString('es-AR');
                    const fIng = item.fecha_ingreso ? new Date(item.fecha_ingreso).toLocaleDateString('es-AR') : '---';
                    const fCie = item.fecha_cierre ? new Date(item.fecha_cierre).toLocaleDateString('es-AR') : '---';
                    
                    let fila = `<tr><td>#${item.id}</td><td style="font-size: 0.85em;">${fReg}</td><td><strong>${item.cliente_nombre}</strong><br><small>${item.cliente_telefono}</small></td><td><small>${item.cliente_email || '---'}</small></td><td><code>${item.prod_codigo}</code></td><td style="font-size: 0.85em;">${item.descripcion}</td><td style="text-align:center">${item.prod_cantidad}</td><td style="font-weight:bold">$${item.total_reserva}</td><td><span class="badge">${item.estado}</span></td>`;
                    
                    if (estadoActualFiltrado === 'En Tr√°nsito') {
                        fila += `<td><strong>${item.sucursal_nombre}</strong><br><small>(${item.sucursal_contacto || 'Sin Datos'})</small></td><td>${item.operador_nombre}</td>`;
                    }
                    else if (estadoActualFiltrado === 'Pendiente de Retiro') fila += `<td><strong>${item.responsable_recibo || '---'}</strong><br><small>${fIng}</small></td>`;
                    else if (estadoActualFiltrado === 'Finalizado') fila += `<td><strong>${item.responsable_finalizado || '---'}</strong><br><small>${fCie}</small></td>`;
                    else if (estadoActualFiltrado === 'Eliminados') fila += `<td>${item.responsable_recibo || '---'}</td><td>${item.responsable_finalizado || '---'}</td><td>${item.operador_nombre || '---'}</td>`;
                    
                    if (rol === 'admin') fila += `<td style="color: #89b4fa; font-weight: bold;">${item.local_origen || 'S/D'}</td>`;
                    fila += `<td><div class="celda-acciones">${getBotonesAccion(item)}</div></td></tr>`;
                    tabla.innerHTML += fila;
                });
            });
    }

    function getBotonesAccion(item) {
        const rol = sessionStorage.getItem('usuario_rol');
        let botones = "";
        if (item.borrado === 1) {
            if (rol === 'admin' || rol === 'encargado') {
                botones += `<select onchange="restaurarReserva(${item.id}, this.value)" class="select-restaurar"><option value="">Restaurar a...</option><option value="En Tr√°nsito">En Tr√°nsito</option><option value="Pendiente de Retiro">Pendiente de Retiro</option></select>`;
                if (rol === 'admin') botones += `<button class="btn-borrar" onclick="confirmarEliminarDefinitivo(${item.id})">ELIMINAR DB</button>`;
                return botones;
            }
            return "";
        }
        if (item.estado === 'En Tr√°nsito') {
            botones += `<button class="btn-azul" onclick="cambiarEstadoConFirma(${item.id}, 'Pendiente de Retiro', '¬øConfirmar ingreso al local?', true)">CONFIRMAR INGRESO</button>`;
            if (rol === 'admin' || rol === 'encargado') {
                const itemData = JSON.stringify(item).replace(/'/g, "&apos;");
                botones += `<button class="btn-azul" style="background:#f39c12; margin-left:5px;" onclick='abrirModalEditar(${itemData})'>EDITAR</button>`;
            }
        } else if (item.estado === 'Pendiente de Retiro') {
            botones += `<button class="btn-azul" style="background:#a6e3a1; color:#1e1e2e;" onclick="cambiarEstadoConFirma(${item.id}, 'Retirado', '¬øConfirmar entrega al cliente?')">RETIRADO</button>`;
            botones += `<button class="btn-borrar" style="margin-left:5px;" onclick="cambiarEstadoConFirma(${item.id}, 'Cancelado', '¬øDesea cancelar esta reserva?')">CANCELADO</button>`;
        } else if (item.estado === 'Retirado' || item.estado === 'Cancelado') {
            // CORREGIDO: Ahora pide firma para mover a papelera
            if (rol === 'admin' || rol === 'encargado') {
                botones += `<button class="btn-borrar" onclick="abrirModalBorradoLogico(${item.id})">BORRAR</button>`;
            }
        }
        return botones;
    }

    function abrirModalBorradoLogico(id) {
        const btnAceptar = document.getElementById('modalAceptar');
        btnAceptar.onclick = function() {
            const resp = document.getElementById('inputNombreResponsable').value.trim();
            if (!resp) return alert("Ingrese su nombre para autorizar.");

            fetch(`/reservas/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    estado: 'Eliminado', 
                    borrado: 1, 
                    responsable: `${resp} (Borr√≥)` 
                })
            }).then(res => {
                if (res.ok) {
                    cerrarModalFirma();
                    cargarReservas();
                    mostrarAviso('üóëÔ∏è Papelera', 'Reserva movida a Eliminados.', false);
                }
            });
        };
        abrirModalFirma("¬øSeguro que desea enviar esta reserva a la papelera?", true, null);
    }

    function restaurarReserva(id, nuevoEstado) {
        if (!nuevoEstado) return;
        fetch(`/reservas/${id}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ estado: nuevoEstado, borrado: 0 })
        }).then(res => {
            if (res.ok) {
                cargarReservas();
                mostrarAviso('‚ôªÔ∏è Restaurada', `Reserva movida a ${nuevoEstado}`, false);
            }
        });
    }

    // --- L√ìGICA DE EDICI√ìN ---
    async function abrirModalEditar(item) {
        document.getElementById('editId').value = item.id;
        document.getElementById('editNombre').value = item.cliente_nombre;
        document.getElementById('editTel').value = item.cliente_telefono;
        document.getElementById('editEmail').value = item.cliente_email || '';
        document.getElementById('editCodigo').value = item.prod_codigo;
        document.getElementById('editDesc').value = item.descripcion;
        document.getElementById('editCant').value = item.prod_cantidad;
        document.getElementById('editTotal').value = item.total_reserva;
        await buscarProductoEditar(false);
        document.getElementById('modalEditar').style.display = 'flex';
    }

    async function buscarProductoEditar(limpiarSiNoExiste = true) {
        const codigo = document.getElementById('editCodigo').value.trim();
        if (!codigo) return;
        try {
            const res = await fetch(`/productos/${codigo}`);
            if (res.ok) {
                const p = await res.json();
                document.getElementById('editDesc').value = p.descripcion;
                document.getElementById('editPrecioU').value = p.precio_unitario;
                calcularTotalEditar();
            } else if (limpiarSiNoExiste) {
                document.getElementById('editDesc').value = 'Producto no encontrado';
                document.getElementById('editPrecioU').value = 0;
                document.getElementById('editTotal').value = 0;
            }
        } catch (e) { console.error("Error al buscar producto", e); }
    }

    function calcularTotalEditar() {
        const precio = parseFloat(document.getElementById('editPrecioU').value) || 0;
        const cant = parseInt(document.getElementById('editCant').value) || 0;
        document.getElementById('editTotal').value = (precio * cant).toFixed(2);
    }

    function guardarEdicion() {
        const nombreCli = document.getElementById('editNombre').value.trim();
        const cant = parseInt(document.getElementById('editCant').value) || 0;
        if (!nombreCli || cant <= 0) return alert("Complete los campos obligatorios.");

        const btnAceptar = document.getElementById('modalAceptar');
        btnAceptar.onclick = function() {
            const responsable = document.getElementById('inputNombreResponsable').value.trim();
            if (!responsable) return alert("Ingrese su nombre para la edici√≥n.");

            const id = document.getElementById('editId').value;
            const data = {
                cliente_nombre: nombreCli,
                cliente_telefono: document.getElementById('editTel').value.trim(),
                cliente_email: document.getElementById('editEmail').value.trim(),
                prod_codigo: document.getElementById('editCodigo').value.trim(),
                descripcion: document.getElementById('editDesc').value.trim(),
                prod_cantidad: cant,
                total_reserva: parseFloat(document.getElementById('editTotal').value) || 0,
                responsable_edicion: responsable
            };

            fetch(`/reservas/${id}/editar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => {
                if (res.ok) {
                    cerrarModalFirma();
                    cerrarEditar();
                    cargarReservas();
                    mostrarAviso('‚úÖ Editado', 'Operador actualizado correctamente.', false);
                }
            });
        };
        abrirModalFirma("¬øConfirmas los cambios en esta reserva?", true, null);
    }

    function mostrarQR(id) {
        const item = reservasCargadas.find(r => r.id == id);
        if (!item) return;
        let tel = item.cliente_telefono.replace(/\D/g, '');
        if (tel.startsWith('0')) tel = tel.substring(1);
        if (!tel.startsWith('549')) tel = '549' + tel;
        const msg = `Hola *${item.cliente_nombre}*! üëã\n\nTu pedido ya lleg√≥ y est√° listo en:\nüìç *${item.local_origen}*\n¬°Te esperamos! üõí`;
        const url = `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
        document.getElementById('modalQR').style.display = 'flex';
        setTimeout(() => { 
            QRCode.toCanvas(document.getElementById('canvasQR'), url, { width: 240, margin: 2 }); 
        }, 200);
    }

    function cambiarEstadoConFirma(id, nuevoEstado, preg, activarQR = false) {
        const btnAceptar = document.getElementById('modalAceptar');
        btnAceptar.onclick = function() {
            const resp = document.getElementById('inputNombreResponsable').value.trim();
            if (!resp) return alert("Ingrese su nombre");
            fetch(`/reservas/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado, responsable: resp })
            }).then(res => { 
                if(res.ok) { cerrarModalFirma(); if(activarQR) mostrarQR(id); else cargarReservas(); } 
            });
        };
        abrirModalFirma(preg, true, null);
    }

    function abrirModalFirma(pregunta, requiereInput, accionOpcional) {
        document.getElementById('mensajeFirma').textContent = pregunta;
        document.getElementById('contenedorInputFirma').style.display = requiereInput ? 'block' : 'none';
        document.getElementById('modalFirma').style.display = 'flex';
        if(accionOpcional) document.getElementById('modalAceptar').onclick = accionOpcional;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rol = sessionStorage.getItem('usuario_rol');
        if (rol === 'admin' || rol === 'encargado') document.getElementById('btnTabEliminados').style.display = 'inline-block';
        actualizarEncabezados();
        cargarReservas();
    });

    document.getElementById('buscador').addEventListener('input', (e) => cargarReservas(e.target.value));

    // Borrado definitivo: Mueve de 'reservas' a 'borrados_definitivos'
function confirmarEliminarDefinitivo(id) {
    // Usamos el modal de firma pero sin el input de nombre, solo como confirmaci√≥n
    const btnAceptar = document.getElementById('modalAceptar');
    
    btnAceptar.onclick = function() {
        fetch(`/admin/reservas-eliminar/${id}`, {
            method: 'DELETE'
        })
        .then(res => {
            if (res.ok) {
                cerrarModalFirma();
                cargarReservas();
                mostrarAviso('üö´ Eliminado', 'La reserva ha sido borrada de la base de datos y archivada.', true);
            } else {
                alert("Error al eliminar de la base de datos.");
            }
        });
    };

    // Abrimos el modal con el input oculto (falso) porque es una acci√≥n de Admin directa
    abrirModalFirma("¬øDesea eliminar DEFINITIVAMENTE esta reserva? Se guardar√° un historial en la tabla de borrados.", false, null);
}
</script>
</body>
</html>