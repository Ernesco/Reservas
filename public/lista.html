<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Lista de Reservas</title>
</head>
<body>

    <header>
        <div class="logo-texto">üõí SISTEMA RESERVAS</div>
        <a href="panel.html" class="btn-header">üè† INICIO</a>
    </header>

    <div class="contenedor-lista">    
        <div class="encabezado-total">
            <h2 style="margin-bottom: 20px; text-align: left;">üìã Gesti√≥n de Reservas</h2>

            <div class="fila-controles">
                <div class="filtros-estados">
                    <button class="btn-filtro active" onclick="filtrarEstado('En Tr√°nsito')">En Tr√°nsito</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Pendiente de Retiro')">Pendiente de Retiro</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Finalizado')">Finalizado</button>
                    <button id="btnTabEliminados" class="btn-filtro" onclick="filtrarEstado('Eliminados')" style="display: none; border-color: #f38ba8; color: #f38ba8;">üóëÔ∏è Eliminados</button>
                </div>

                <input type="text" id="buscador" placeholder="üîç Buscar cliente o producto..." style="margin: 0; width: 300px;">
            </div>
        </div>

        <div style="overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 10px;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>C√≥digo</th>
                        <th>Descripci√≥n</th>
                        <th>Cant.</th>
                        <th>Total ($)</th>
                        <th>Estado</th>
                        <th>Operador</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
    </div>

<script>
    let estadoActualFiltrado = 'En Tr√°nsito';

    function filtrarEstado(estado) {
        estadoActualFiltrado = estado;
        document.querySelectorAll('.btn-filtro').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.trim().includes(estado));
        });
        cargarReservas(document.getElementById('buscador').value);
    }

    function cargarReservas(busqueda = '') {
        const tabla = document.getElementById('tablaCuerpo');
        const sucursalUsuario = sessionStorage.getItem('usuario_sucursal');
        const rolUsuario = sessionStorage.getItem('usuario_rol'); 

        tabla.innerHTML = '<tr><td colspan="10" style="text-align:center">Cargando...</td></tr>';

        // Mantenemos la llamada al server igual, pero filtramos en el cliente para mayor seguridad inmediata
        fetch(`/reservas?q=${busqueda}`)
            .then(response => response.json())
            .then(datos => {
                tabla.innerHTML = '';

                // FILTRADO DE PRIVACIDAD Y ESTADO
                const filtrados = datos.filter(item => {
                    // 1. Filtro de Privacidad: Si no es admin, solo ve lo que gener√≥ su sucursal (local_origen)
                    if (rolUsuario !== 'admin' && item.local_origen !== sucursalUsuario) {
                        return false;
                    }

                    // 2. Filtro de pesta√±as (Estados / Eliminados)
                    if (estadoActualFiltrado === 'Eliminados') return item.borrado === 1;
                    if (estadoActualFiltrado === 'Finalizado') {
                        return (item.estado === 'Retirado' || item.estado === 'Cancelado') && item.borrado === 0;
                    }
                    return item.estado === estadoActualFiltrado && item.borrado === 0;
                });

                if(filtrados.length === 0) {
                    tabla.innerHTML = `<tr><td colspan="10" style="text-align:center">No hay reservas para mostrar</td></tr>`;
                    return;
                }

                filtrados.forEach(item => {
                    const fecha = new Date(item.fecha_registro).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' });
                    const claseEstado = item.estado.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-');
                    const estiloFila = item.borrado === 1 ? 'style="opacity: 0.7; background-color: #2a1b1b;"' : '';
                    
                    const precioTotal = item.total_reserva ? parseFloat(item.total_reserva).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '0,00';

                    // Correcci√≥n del Operador: Mostramos el nombre guardado y el local que gestion√≥
                    const operadorTexto = item.operador_nombre ? `${item.operador_nombre} (${item.local_origen || 'S/D'})` : 'Sin datos';

                    const fila = `
                        <tr ${estiloFila}>
                            <td>#${item.id}</td>
                            <td style="font-size: 0.85em;">${fecha}</td>
                            <td><strong>${item.cliente_nombre}</strong><br><small style="color: #89b4fa">${item.cliente_telefono}</small></td>
                            <td><code>${item.prod_codigo}</code></td>
                            <td style="font-size: 0.9em; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.descripcion || '---'}</td>
                            <td style="text-align: center;">${item.prod_cantidad}</td>
                            <td style="font-weight: bold; color: #a6e3a1;">$${precioTotal}</td>
                            <td><span class="badge estado-${claseEstado}">${item.estado}</span></td>
                            <td><small>${operadorTexto}</small></td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    ${getBotonesAccion(item)}
                                </div>
                            </td>
                        </tr>
                    `;
                    tabla.innerHTML += fila;
                });
            })
            .catch(err => mostrarError("Error al cargar datos"));
    }

    function getBotonesAccion(item) {
        if (item.borrado === 1) {
            return `<button class="btn-azul" style="background:#89b4fa; color:#1e1e2e; padding: 5px 10px; font-size: 11px;" onclick="restaurarReserva(${item.id})">RESTAURAR</button>`;
        }
        if (item.estado === 'En Tr√°nsito') {
            return `<button class="btn-azul" style="padding: 5px 10px; font-size: 11px;" onclick="cambiarEstado(${item.id}, 'Pendiente de Retiro')">LLEG√ì A LOCAL</button>`;
        } else if (item.estado === 'Pendiente de Retiro') {
            return `
                <button class="btn-azul" style="background:#a6e3a1; color:#1e1e2e; padding: 5px 10px; font-size: 11px;" onclick="cambiarEstado(${item.id}, 'Retirado')">ENTREGADO</button>
                <button class="btn-borrar" style="padding: 5px 10px; font-size: 11px;" onclick="cambiarEstado(${item.id}, 'Cancelado')">CANCELAR</button>
            `;
        } else {
            return `<button class="btn-borrar" style="padding: 5px 10px; font-size: 11px;" onclick="borrarReserva(${item.id})">ELIMINAR</button>`;
        }
    }

    function cambiarEstado(id, nuevoEstado) {
        fetch(`/reservas/${id}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ estado: nuevoEstado })
        }).then(res => { if(res.ok) cargarReservas(); });
    }

    function restaurarReserva(id) {
        fetch(`/reservas/${id}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ borrado: 0 })
        }).then(res => { if(res.ok) cargarReservas(); });
    }

    function borrarReserva(id) {
        const modal = document.getElementById('modalBorrar');
        modal.style.display = 'flex';
        document.getElementById('confirmarBorrar').onclick = function() {
            fetch(`/reservas/${id}`, { method: 'DELETE' })
            .then(res => { 
                if(res.ok) {
                    modal.style.display = 'none';
                    cargarReservas(); 
                }
            });
        }
        document.getElementById('cancelarBorrar').onclick = () => modal.style.display = 'none';
    }

    function mostrarError(mensaje) {
        const modal = document.getElementById('modalError');
        document.getElementById('mensajeErrorTexto').textContent = mensaje;
        modal.style.display = 'flex';
        document.getElementById('btnCerrarError').onclick = () => modal.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!sessionStorage.getItem('usuario_nombre')) {
            window.location.href = 'index.html';
            return;
        }
        const rolActual = sessionStorage.getItem('usuario_rol');
        if (rolActual === 'admin') {
            document.getElementById('btnTabEliminados').style.display = 'block';
        }
        cargarReservas();
    });

    document.getElementById('buscador').addEventListener('input', (e) => cargarReservas(e.target.value));
</script>

    <div id="modalBorrar" class="modal-overlay">
        <div class="modal-caja">
            <h3>‚ö†Ô∏è Confirmaci√≥n</h3>
            <p>¬øEst√°s seguro de que deseas borrar esta reserva?</p>
            <div class="modal-botones">
                <button id="confirmarBorrar" class="btn-azul" style="background-color: #f38ba8;">Eliminar</button>
                <button id="cancelarBorrar" class="btn-secundario">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalError" class="modal-overlay">
        <div class="modal-caja" style="border-color: #f38ba8;">
            <h3 style="color: #f38ba8;">‚ùå Error</h3>
            <p id="mensajeErrorTexto"></p>
            <div class="modal-botones">
                <button id="btnCerrarError" class="btn-azul" style="background-color: #f38ba8;">Aceptar</button>
            </div>
        </div>
    </div>

</body>
</html>