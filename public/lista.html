<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Gesti√≥n de Reservas</title>
</head>
<body>

    <header>
        <div class="logo-texto">üõí SISTEMA RESERVAS</div>
        <a href="panel.html" class="btn-header">üè† INICIO</a>
    </header>

    <div class="contenedor-lista">    
        <div class="encabezado-total">
            <h2 style="margin-bottom: 20px; text-align: left;">üìã Gesti√≥n de Reservas</h2>

            <div class="fila-controles">
                <div class="filtros-estados">
                    <button class="btn-filtro active" onclick="filtrarEstado('En Tr√°nsito')">En Tr√°nsito</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Pendiente de Retiro')">Pendiente de Retiro</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Finalizado')">Finalizado</button>
                    <button id="btnTabEliminados" class="btn-filtro" onclick="filtrarEstado('Eliminados')" style="display: none; border-color: #f38ba8; color: #f38ba8;">üóëÔ∏è Eliminados</button>
                </div>
                <input type="text" id="buscador" placeholder="üîç Buscar cliente, c√≥digo o local..." style="margin: 0; width: 300px;">
            </div>
        </div>

        <div class="tabla-scroll-container">
            <table id="tablaReservas">
                <thead>
                    <tr id="encabezadoTabla"></tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
    </div>

    <div id="modalFirma" class="modal-overlay">
        <div class="modal-caja">
            <h3 id="tituloFirma" style="color: #89b4fa;">‚ö†Ô∏è Confirmaci√≥n</h3>
            <p id="mensajeFirma" style="margin-bottom: 20px;"></p>
            
            <div id="contenedorInputFirma" style="margin-bottom: 20px; width: 100%;">
                <label style="color: #cdd6f4; display: block; margin-bottom: 10px; text-align: left;">Ingrese su nombre para registrar la acci√≥n:</label>
                <input type="text" id="inputNombreResponsable" placeholder="Su nombre aqu√≠..." 
                       style="background: #313244; color: white; border: 1px solid #45475a; padding: 12px; width: 100%; border-radius: 6px; box-sizing: border-box;">
            </div>

            <div class="modal-botones" style="width: 100%;">
                <button id="modalAceptar" class="btn-azul">CONFIRMAR</button>
                <button onclick="cerrarModalFirma()" id="modalCancelar">CANCELAR</button>
            </div>
        </div>
    </div>

<script>
    let estadoActualFiltrado = 'En Tr√°nsito';

    function actualizarEncabezados() {
        const header = document.getElementById('encabezadoTabla');
        const rol = sessionStorage.getItem('usuario_rol');
        let columnas = `<th>ID</th><th>Fecha</th><th>Cliente</th><th>Email</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant.</th><th>Total</th><th>Estado</th>`;

        if (estadoActualFiltrado === 'En Tr√°nsito') {
            columnas += `<th>Pedido a</th><th>Contacto</th>`;
        } else if (estadoActualFiltrado === 'Pendiente de Retiro') {
            columnas += `<th>Ingres√≥ al Local</th>`;
        } else if (estadoActualFiltrado === 'Finalizado') {
            columnas += `<th>Cerrado por</th>`;
        } else if (estadoActualFiltrado === 'Eliminados') {
            columnas += `<th>Recibi√≥</th><th>Finaliz√≥</th>`;
        }

        columnas += `<th>Operador</th>`;
        if (rol === 'admin') columnas += `<th>Origen</th>`;
        columnas += `<th>Acciones</th>`;
        header.innerHTML = columnas;
    }

    function filtrarEstado(estado) {
        estadoActualFiltrado = estado;
        // L√≥gica de resaltado de solapas (tabs)
        document.querySelectorAll('.btn-filtro').forEach(btn => {
            if (btn.textContent.trim().includes(estado)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        actualizarEncabezados();
        cargarReservas(document.getElementById('buscador').value);
    }

    function cargarReservas(busqueda = '') {
        const tabla = document.getElementById('tablaCuerpo');
        const sucursal = sessionStorage.getItem('usuario_sucursal');
        const rol = sessionStorage.getItem('usuario_rol'); 

        fetch(`/reservas?q=${busqueda}&sucursal=${sucursal}&rol=${rol}`)
            .then(res => res.json())
            .then(datos => {
                tabla.innerHTML = '';
                const filtrados = datos.filter(item => {
                    if (estadoActualFiltrado === 'Eliminados') return item.borrado === 1;
                    if (estadoActualFiltrado === 'Finalizado') return (item.estado === 'Retirado' || item.estado === 'Cancelado') && item.borrado === 0;
                    return item.estado === estadoActualFiltrado && item.borrado === 0;
                });

                if(filtrados.length === 0) {
                    tabla.innerHTML = `<tr><td colspan="25" style="text-align:center; padding: 20px;">No hay registros para mostrar.</td></tr>`;
                    return;
                }

                filtrados.forEach(item => {
                    const fecha = new Date(item.fecha_registro).toLocaleDateString('es-AR');
                    let fila = `<tr>
                        <td>#${item.id}</td>
                        <td style="font-size: 0.9em;">${fecha}</td>
                        <td><strong>${item.cliente_nombre}</strong><br><small>${item.cliente_telefono}</small></td>
                        <td><small>${item.cliente_email || '---'}</small></td>
                        <td><code>${item.prod_codigo}</code></td>
                        <td style="font-size: 0.85em;">${item.descripcion}</td>
                        <td style="text-align:center">${item.prod_cantidad}</td>
                        <td style="font-weight:bold">$${item.total_reserva}</td>
                        <td><span class="badge">${item.estado}</span></td>`;

                    if (estadoActualFiltrado === 'En Tr√°nsito') {
                        fila += `<td>${item.sucursal_nombre}</td><td>${item.sucursal_contacto}</td>`;
                    } else if (estadoActualFiltrado === 'Pendiente de Retiro') {
                        fila += `<td>${item.responsable_recibo || '---'}</td>`;
                    } else if (estadoActualFiltrado === 'Finalizado') {
                        fila += `<td>${item.responsable_finalizado || '---'}</td>`;
                    } else if (estadoActualFiltrado === 'Eliminados') {
                        fila += `<td>${item.responsable_recibo || '---'}</td><td>${item.responsable_finalizado || '---'}</td>`;
                    }

                    fila += `<td>${item.operador_nombre}</td>`;
                    if (rol === 'admin') fila += `<td style="color: #89b4fa; font-weight: bold;">${item.local_origen || 'S/D'}</td>`;

                    // Los botones ahora se generan dentro de un contenedor para que el CSS los controle mejor
                    fila += `<td><div class="celda-acciones">${getBotonesAccion(item)}</div></td></tr>`;
                    tabla.innerHTML += fila;
                });
            });
    }

    function getBotonesAccion(item) {
        if (item.borrado === 1) {
            return `
                <select onchange="restaurarEspecial(${item.id}, this.value)" style="padding:5px; border-radius:5px; font-size:11px; background:#313244; color:white;">
                    <option value="">Restaurar a...</option>
                    <option value="En Tr√°nsito">En Tr√°nsito</option>
                    <option value="Pendiente de Retiro">Pendiente de Retiro</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
                <button class="btn-borrar" onclick="confirmarEliminarDefinitivo(${item.id})">ELIMINAR DEF.</button>
            `;
        }
        if (item.estado === 'En Tr√°nsito') {
            return `<button class="btn-azul" onclick="cambiarEstadoConFirma(${item.id}, 'Pendiente de Retiro', '¬øConfirma que el pedido lleg√≥ al local?')">LLEG√ì AL LOCAL</button>`;
        } 
        if (item.estado === 'Pendiente de Retiro') {
            return `
                <button class="btn-azul" style="background:#a6e3a1; color:#1e1e2e;" onclick="cambiarEstadoConFirma(${item.id}, 'Retirado', '¬øConfirma que el cliente retir√≥ el producto?')">RETIRADO</button>
                <button class="btn-borrar" onclick="cambiarEstadoConFirma(${item.id}, 'Cancelado', '¬øDesea cancelar esta reserva?')">CANCELAR</button>
            `;
        }
        return `<button class="btn-borrar" onclick="confirmarBorrarReserva(${item.id})">ELIMINAR</button>`;
    }

    function abrirModalFirma(pregunta, requiereInput = true, accionCallback) {
        document.getElementById('mensajeFirma').textContent = pregunta;
        document.getElementById('contenedorInputFirma').style.display = requiereInput ? 'block' : 'none';
        document.getElementById('modalFirma').style.display = 'flex';
        
        if(requiereInput) document.getElementById('inputNombreResponsable').focus();
        
        document.getElementById('modalAceptar').onclick = accionCallback;
    }

    function cerrarModalFirma() {
        document.getElementById('modalFirma').style.display = 'none';
        document.getElementById('inputNombreResponsable').value = '';
    }

    function cambiarEstadoConFirma(id, nuevoEstado, pregunta) {
        abrirModalFirma(pregunta, true, () => {
            const responsable = document.getElementById('inputNombreResponsable').value.trim();
            if (responsable === "") {
                alert("Por favor, ingrese su nombre para registrar el cambio.");
                return;
            }
            fetch(`/reservas/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado, responsable: responsable })
            }).then(res => { if(res.ok) { cerrarModalFirma(); cargarReservas(); } });
        });
    }

    function confirmarBorrarReserva(id) {
        abrirModalFirma("¬øEst√° seguro que desea enviar esta reserva a la papelera?", false, () => {
            fetch(`/reservas/${id}`, { method: 'DELETE' })
            .then(res => { if(res.ok) { cerrarModalFirma(); cargarReservas(); } });
        });
    }

    function confirmarEliminarDefinitivo(id) {
        abrirModalFirma("‚ö†Ô∏è ¬°ADVERTENCIA! Esta reserva se mover√° al archivo hist√≥rico y desaparecer√° de la p√°gina.", false, () => {
            fetch(`/reservas_definitivas/${id}`, { method: 'DELETE' })
            .then(res => { if(res.ok) { cerrarModalFirma(); cargarReservas(); } });
        });
    }

    function restaurarEspecial(id, estadoDestino) {
        if (!estadoDestino) return;
        abrirModalFirma(`¬øRestaurar reserva #${id} al estado ${estadoDestino}?`, false, () => {
            fetch(`/reservas/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ borrado: 0, estado: estadoDestino })
            }).then(res => { if(res.ok) { cerrarModalFirma(); cargarReservas(); } });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rol = sessionStorage.getItem('usuario_rol');
        if (rol === 'admin') document.getElementById('btnTabEliminados').style.display = 'inline-block';
        actualizarEncabezados();
        cargarReservas();
    });

    document.getElementById('buscador').addEventListener('input', (e) => cargarReservas(e.target.value));
</script>
</body>
</html>