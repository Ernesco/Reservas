<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Gesti√≥n de Reservas</title>
</head>
<body>

    <header>
        <div class="logo-texto">üõí SISTEMA RESERVAS</div>
        <a href="panel.html" class="btn-header">üè† INICIO</a>
    </header>

    <div class="contenedor-lista">    
        <div class="encabezado-total">
            <h2 style="margin-bottom: 20px; text-align: left;">üìã Gesti√≥n de Reservas</h2>

            <div class="fila-controles">
                <div class="filtros-estados">
                    <button class="btn-filtro active" onclick="filtrarEstado('En Tr√°nsito')">En Tr√°nsito</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Pendiente de Retiro')">Pendiente de Retiro</button>
                    <button class="btn-filtro" onclick="filtrarEstado('Finalizado')">Finalizado</button>
                    <button id="btnTabEliminados" class="btn-filtro" onclick="filtrarEstado('Eliminados')" style="display: none; border-color: #f38ba8; color: #f38ba8;">üóëÔ∏è Eliminados</button>
                </div>
                <input type="text" id="buscador" placeholder="üîç Buscar cliente o producto..." style="margin: 0; width: 300px;">
            </div>
        </div>

        <div style="overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 10px;">
            <table id="tablaReservas">
                <thead>
                    <tr id="encabezadoTabla">
                        </tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
    </div>

<script>
    let estadoActualFiltrado = 'En Tr√°nsito';

    // 1. Configuraci√≥n de columnas din√°micas seg√∫n el estado
    function actualizarEncabezados() {
        const header = document.getElementById('encabezadoTabla');
        let columnas = `<th>ID</th><th>Fecha</th><th>Cliente</th><th>Email</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant.</th><th>Total</th><th>Estado</th>`;

        if (estadoActualFiltrado === 'En Tr√°nsito') {
            columnas += `<th>Pedido a</th><th>Contacto</th><th>Operador</th>`;
        } else if (estadoActualFiltrado === 'Pendiente de Retiro') {
            columnas += `<th>Ingres√≥ al Local</th><th>Operador Original</th>`;
        } else if (estadoActualFiltrado === 'Finalizado') {
            columnas += `<th>Cerrado por</th><th>Operador Original</th>`;
        } else if (estadoActualFiltrado === 'Eliminados') {
            columnas += `<th>Recibi√≥</th><th>Finaliz√≥</th><th>Op. Original</th>`;
        }
        
        columnas += `<th>Acciones</th>`;
        header.innerHTML = columnas;
    }

    function filtrarEstado(estado) {
        estadoActualFiltrado = estado;
        document.querySelectorAll('.btn-filtro').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.trim().includes(estado));
        });
        actualizarEncabezados();
        cargarReservas(document.getElementById('buscador').value);
    }

    function cargarReservas(busqueda = '') {
        const tabla = document.getElementById('tablaCuerpo');
        const sucursal = sessionStorage.getItem('usuario_sucursal');
        const rol = sessionStorage.getItem('usuario_rol'); 

        fetch(`/reservas?q=${busqueda}&sucursal=${sucursal}&rol=${rol}`)
            .then(res => res.json())
            .then(datos => {
                tabla.innerHTML = '';
                const filtrados = datos.filter(item => {
                    if (estadoActualFiltrado === 'Eliminados') return item.borrado === 1;
                    if (estadoActualFiltrado === 'Finalizado') return (item.estado === 'Retirado' || item.estado === 'Cancelado') && item.borrado === 0;
                    return item.estado === estadoActualFiltrado && item.borrado === 0;
                });

                if(filtrados.length === 0) {
                    tabla.innerHTML = `<tr><td colspan="20" style="text-align:center; padding: 20px;">No hay registros para mostrar en este estado.</td></tr>`;
                    return;
                }

                filtrados.forEach(item => {
                    const fecha = new Date(item.fecha_registro).toLocaleDateString('es-AR');
                    let fila = `<tr>
                        <td>#${item.id}</td>
                        <td style="font-size: 0.9em;">${fecha}</td>
                        <td><strong>${item.cliente_nombre}</strong><br><small>${item.cliente_telefono}</small></td>
                        <td><small>${item.cliente_email || '---'}</small></td>
                        <td><code>${item.prod_codigo}</code></td>
                        <td style="font-size: 0.85em;">${item.descripcion}</td>
                        <td style="text-align:center">${item.prod_cantidad}</td>
                        <td style="font-weight:bold">$${item.total_reserva}</td>
                        <td><span class="badge">${item.estado}</span></td>`;

                    // Celdas din√°micas seg√∫n el estado actual
                    if (estadoActualFiltrado === 'En Tr√°nsito') {
                        fila += `<td>${item.sucursal_nombre}</td><td>${item.sucursal_contacto}</td><td>${item.operador_nombre}</td>`;
                    } else if (estadoActualFiltrado === 'Pendiente de Retiro') {
                        fila += `<td>${item.responsable_recibo || '---'}</td><td>${item.operador_nombre}</td>`;
                    } else if (estadoActualFiltrado === 'Finalizado') {
                        fila += `<td>${item.responsable_finalizado || '---'}</td><td>${item.operador_nombre}</td>`;
                    } else if (estadoActualFiltrado === 'Eliminados') {
                        fila += `<td>${item.responsable_recibo || '---'}</td><td>${item.responsable_finalizado || '---'}</td><td>${item.operador_nombre}</td>`;
                    }

                    fila += `<td><div style="display:flex; flex-direction:column; gap:5px;">${getBotonesAccion(item)}</div></td></tr>`;
                    tabla.innerHTML += fila;
                });
            });
    }

    function getBotonesAccion(item) {
        if (item.borrado === 1) {
            return `
                <select onchange="restaurarEspecial(${item.id}, this.value)" style="padding:5px; border-radius:5px; font-size:11px;">
                    <option value="">Restaurar a...</option>
                    <option value="En Tr√°nsito">En Tr√°nsito</option>
                    <option value="Pendiente de Retiro">Pendiente de Retiro</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
                <button class="btn-borrar" onclick="eliminarDefinitivo(${item.id})">ELIMINAR DEF.</button>
            `;
        }
        if (item.estado === 'En Tr√°nsito') {
            return `<button class="btn-azul" onclick="cambiarEstadoConFirma(${item.id}, 'Pendiente de Retiro', '¬øConfirma que el pedido lleg√≥ al local?')">LLEG√ì AL LOCAL</button>`;
        } 
        if (item.estado === 'Pendiente de Retiro') {
            return `
                <button class="btn-azul" style="background:#a6e3a1; color:#1e1e2e;" onclick="cambiarEstadoConFirma(${item.id}, 'Retirado', '¬øConfirma que el cliente retir√≥ el producto?')">RETIRADO</button>
                <button class="btn-borrar" onclick="cambiarEstadoConFirma(${item.id}, 'Cancelado', '¬øDesea cancelar esta reserva?')">CANCELAR</button>
            `;
        }
        return `<button class="btn-borrar" onclick="borrarReserva(${item.id})">ELIMINAR</button>`;
    }

    function cambiarEstadoConFirma(id, nuevoEstado, pregunta) {
        if (confirm(pregunta)) {
            const responsable = prompt("Por favor, ingrese su nombre para registrar el cambio:");
            if (responsable && responsable.trim() !== "") {
                fetch(`/reservas/${id}/estado`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado, responsable: responsable })
                }).then(() => cargarReservas());
            } else if (responsable !== null) {
                alert("Es obligatorio ingresar un nombre para realizar el cambio de estado.");
            }
        }
    }

    function restaurarEspecial(id, estadoDestino) {
        if (!estadoDestino) return;
        fetch(`/reservas/${id}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ borrado: 0, estado: estadoDestino })
        }).then(() => {
            alert(`Reserva #${id} restaurada a estado: ${estadoDestino}`);
            cargarReservas();
        });
    }

    function borrarReserva(id) {
        if (confirm("¬øEnviar esta reserva a la papelera?")) {
            fetch(`/reservas/${id}`, { method: 'DELETE' }).then(() => cargarReservas());
        }
    }

    function eliminarDefinitivo(id) {
        if (confirm("‚ö†Ô∏è ¬°ADVERTENCIA! Esta reserva se mover√° al archivo hist√≥rico y desaparecer√° de la p√°gina. ¬øContinuar?")) {
            fetch(`/reservas_definitivas/${id}`, { method: 'DELETE' }).then(() => cargarReservas());
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rol = sessionStorage.getItem('usuario_rol');
        if (rol === 'admin') document.getElementById('btnTabEliminados').style.display = 'block';
        actualizarEncabezados();
        cargarReservas();
    });

    document.getElementById('buscador').addEventListener('input', (e) => cargarReservas(e.target.value));
</script>

    <div id="modalError" class="modal-overlay">
        <div class="modal-caja" style="border-color: #f38ba8;">
            <h3 style="color: #f38ba8;">‚ùå Error</h3>
            <p id="mensajeErrorTexto"></p>
            <div class="modal-botones">
                <button onclick="document.getElementById('modalError').style.display='none'" class="btn-azul">Aceptar</button>
            </div>
        </div>
    </div>

</body>
</html>