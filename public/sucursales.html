<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">document.oncontextmenu = function(){return false;}</script>
    <title>One Box - Gesti√≥n de Sucursales</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo-texto">‚öôÔ∏è Configuraci√≥n de Locales</div>
        <a href="panel.html" class="btn-header">üè† VOLVER</a>
    </header>

    <div class="contenedor-lista">    
        <div class="encabezado-total">
            <h2>üìç Horarios y Direcciones</h2>
            <p>La informaci√≥n aqu√≠ cargada se enviar√° autom√°ticamente en los correos de "Pedido Disponible".</p>
        </div>
    </div>

        <div class="tabla-scroll-container">
            <table id="tablaReservas"> 
                <thead>
                    <tr>
                        <th style="text-align: left; padding: 15px;">Sucursal (Nombre DB)</th>
                        <th style="text-align: left; padding: 15px;">Direcci√≥n / Horarios</th>
                        <th style="text-align: center; padding: 15px;">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="cuerpoSucursales">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="modalSucursal" class="modal-overlay">
        <div class="modal-caja">
            <h3 id="tituloModal" style="color: #89b4fa;">Editar Local</h3>
            <form id="formSucursal">
                <input type="hidden" id="sucId">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Nombre de la Sucursal (Id√©ntico a Usuario):</label>
                <input type="text" id="sucNombre" required placeholder="Ej: Local Abasto" style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Direcci√≥n:</label>
                <input type="text" id="sucDireccion" required placeholder="Av. Corrientes 123" style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Horarios:</label>
                <input type="text" id="sucHorarios" required placeholder="Lun a Vie 10-20hs" style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Tel√©fono de Contacto:</label>
                <input type="text" id="sucContacto" placeholder="11 1234-5678" style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <div class="modal-botones" style="margin-top: 25px;">
                    <button type="submit" class="btn-azul">GUARDAR</button>
                    <button type="button" onclick="cerrarModal()" class="btn-secundario">CANCELAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Seguridad: Solo admin
        if (sessionStorage.getItem('usuario_rol') !== 'admin') {
            window.location.href = 'panel.html';
        }

        async function cargarSucursales() {
            try {
                const res = await fetch('/admin/sucursales');
                const locales = await res.json();
                const cuerpo = document.getElementById('cuerpoSucursales');
                cuerpo.innerHTML = '';

                locales.forEach(l => {
                    cuerpo.innerHTML += `
                        <tr>
                            <td style="padding: 15px;"><strong>${l.nombre_sucursal}</strong></td>
                            <td style="padding: 15px; font-size: 0.9em; color: #cdd6f4;">
                                üìç ${l.direccion}<br><small style="color: #bac2de;">‚è∞ ${l.horarios}</small>
                            </td>
                            <td style="text-align: center; padding: 15px;">
                                <button class="btn-azul" style="padding: 8px 15px; font-size: 11px;" 
                                    onclick='abrirModal(${JSON.stringify(l)})'>EDITAR</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error cargando sucursales:", error);
            }
        }

        function abrirModal(datos = null) {
            document.getElementById('modalSucursal').style.display = 'flex';
            if (datos) {
                document.getElementById('sucId').value = datos.id;
                document.getElementById('sucNombre').value = datos.nombre_sucursal;
                document.getElementById('sucDireccion').value = datos.direccion;
                document.getElementById('sucHorarios').value = datos.horarios;
                document.getElementById('sucContacto').value = datos.contacto_tel;
            } else {
                document.getElementById('formSucursal').reset();
                document.getElementById('sucId').value = '';
            }
        }

        function cerrarModal() { 
            document.getElementById('modalSucursal').style.display = 'none'; 
        }

        document.getElementById('formSucursal').onsubmit = async (e) => {
            e.preventDefault();
            const body = {
                id: document.getElementById('sucId').value,
                nombre: document.getElementById('sucNombre').value,
                direccion: document.getElementById('sucDireccion').value,
                horarios: document.getElementById('sucHorarios').value,
                contacto: document.getElementById('sucContacto').value
            };

            try {
                const res = await fetch('/admin/sucursales', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    cerrarModal();
                    cargarSucursales();
                }
            } catch (error) {
                alert("Error al guardar los cambios.");
            }
        };

        // Carga inicial
        cargarSucursales();
    </script>
</body>
</html>