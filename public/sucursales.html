<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">document.oncontextmenu = function(){return false;}</script>
    <title>One Box - Gesti√≥n de Sucursales</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo-texto">‚öôÔ∏è Configuraci√≥n de Locales</div>
        <a href="panel.html" class="btn-header">üè† VOLVER</a>
    </header>

    <main class="contenedor-lista">    
        <div class="encabezado-total" style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #ffffff; font-size: 24px;">üìç Horarios y Direcciones</h2>
            <p style="color: #bac2de; max-width: 600px; margin: 10px auto;">
                Edite la informaci√≥n de contacto que se enviar√° en los correos autom√°ticos.
            </p>
        </div>

        <div class="tabla-scroll-container">
            <table id="tablaReservas" style="width: 100%; background-color: #1e1e2e; border-collapse: collapse;"> 
                <thead>
                    <tr>
                        <th style="text-align: left; padding: 15px; background-color: #313244; color: #ffffff;">Sucursal</th>
                        <th style="text-align: left; padding: 15px; background-color: #313244; color: #ffffff;">Direcci√≥n / Horarios</th>
                        <th style="text-align: center; padding: 15px; background-color: #313244; color: #ffffff;">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="cuerpoSucursales"></tbody>
            </table>
        </div>
    </main>

    <div id="modalSucursal" class="modal-overlay">
        <div class="modal-caja">
            <h3 style="color: #89b4fa; text-align: center;">Editar Info de Local</h3>
            <form id="formSucursal">
                <input type="hidden" id="sucId">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Nombre Sucursal (No editable):</label>
                <input type="text" id="sucNombre" readonly style="width: 100%; padding: 10px; margin-top: 5px; background: #1e1e2e; color: #888; border: 1px solid #45475a; border-radius: 6px;">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Direcci√≥n:</label>
                <input type="text" id="sucDireccion" required style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Horarios:</label>
                <input type="text" id="sucHorarios" required style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <label style="color: #bac2de; display: block; margin-top: 10px;">Tel√©fono de Contacto:</label>
                <input type="text" id="sucContacto" required style="width: 100%; padding: 10px; margin-top: 5px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                
                <div class="modal-botones" style="margin-top: 25px; display: flex; justify-content: center; gap: 10px;">
                    <button type="submit" class="btn-azul">ACTUALIZAR DATOS</button>
                    <button type="button" onclick="cerrarModal()" class="btn-secundario">CANCELAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        if (sessionStorage.getItem('usuario_rol') !== 'admin') window.location.href = 'panel.html';

        async function cargarSucursales() {
            try {
                // Ahora pedimos los datos a la tabla usuarios
                const res = await fetch('/admin/usuarios');
                const datos = await res.json();
                const cuerpo = document.getElementById('cuerpoSucursales');
                cuerpo.innerHTML = '';

                datos.forEach(l => {
                    cuerpo.innerHTML += `
                        <tr style="border-bottom: 1px solid #313244;">
                            <td style="padding: 15px; color: #ffffff;"><strong>${l.sucursal}</strong></td>
                            <td style="padding: 15px; font-size: 0.9em; color: #cdd6f4;">
                                üìç ${l.direccion || 'No asignada'}<br><small style="color: #bac2de;">‚è∞ ${l.horarios || 'No asignado'}</small>
                            </td>
                            <td style="text-align: center; padding: 15px;">
                                <button class="btn-azul" style="padding: 8px 15px; font-size: 11px;" 
                                    onclick='abrirModal(${JSON.stringify(l)})'>EDITAR INFO</button>
                            </td>
                        </tr>`;
                });
            } catch (error) { console.error(error); }
        }

        function abrirModal(l) {
            document.getElementById('modalSucursal').style.display = 'flex';
            document.getElementById('sucId').value = l.id;
            document.getElementById('sucNombre').value = l.sucursal;
            document.getElementById('sucDireccion').value = l.direccion || "";
            document.getElementById('sucHorarios').value = l.horarios || "";
            document.getElementById('sucContacto').value = l.contacto_tel || "";
        }

        function cerrarModal() { document.getElementById('modalSucursal').style.display = 'none'; }

        document.getElementById('formSucursal').onsubmit = async (e) => {
            e.preventDefault();
            const body = {
                id: document.getElementById('sucId').value,
                direccion: document.getElementById('sucDireccion').value,
                horarios: document.getElementById('sucHorarios').value,
                contacto_tel: document.getElementById('sucContacto').value
            };

            try {
                // Usamos la ruta de actualizaci√≥n parcial
                const res = await fetch('/admin/usuarios-info', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    cerrarModal();
                    cargarSucursales();
                    alert("‚úÖ Informaci√≥n actualizada correctamente.");
                }
            } catch (error) { alert("Error al guardar."); }
        };

        cargarSucursales();
    </script>
</body>
</html>