<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Nueva Reserva</title>
</head>
<body>

<header>
    <div class="logo-texto">ğŸ›’ SISTEMA RESERVAS</div>
    <a href="index.html" class="btn-header">ğŸ  INICIO</a>
</header>

    <form id="formReservas" class="caja-central">
        <h2 style="color: #1e1e2e; margin-bottom: 20px;">Nueva Reserva</h2>
        
        <fieldset>
            <legend>ğŸ‘¤ Cliente</legend>
            <label>Nombre *</label><input type="text" id="cliente_nombre" required>
            <label>TelÃ©fono *</label><input type="tel" id="cliente_telefono" required>
            <label>Email (opcional)</label><input type="email" id="cliente_email">
        </fieldset>

        <fieldset>
            <legend>ğŸ›’ Producto</legend>
            <label>CÃ³digo *</label><input type="text" id="prod_codigo" required>
            <label>Cantidad *</label><input type="number" id="prod_cantidad" required min="1" value="1">
        </fieldset>

        <fieldset>
            <legend>ğŸ¢ Sucursal</legend>
            <label>Local</label><input type="text" id="sucursal_nombre">
            <label>Contacto</label><input type="text" id="sucursal_contacto">
        </fieldset>

        <fieldset>
            <legend>ğŸ“ Operador</legend>
            <label>Tu Nombre *</label><input type="text" id="operador_nombre" required>
            <label>Comentarios</label><textarea id="comentarios" rows="3"></textarea>
        </fieldset>

        <button type="submit" class="btn-azul">ğŸ’¾ GUARDAR RESERVA</button>
    </form>

    <div id="miModal" class="modal-overlay">
        <div class="modal-caja">
            <h3>âœ… Reservas</h3>
            <p>Guardado con Ã©xito.<br>Â¿QuerÃ©s ver la lista de reservas?</p>
            <div class="modal-botones">
                <button id="modalAceptar" class="btn-azul">Aceptar</button>
                <button id="modalCancelar" class="btn-secundario">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        function mostrarError(mensaje) {
            const modal = document.getElementById('modalError');
            const texto = document.getElementById('mensajeErrorTexto');
            const btnCerrar = document.getElementById('btnCerrarError');

            texto.textContent = mensaje;
            modal.style.display = 'flex';

            btnCerrar.onclick = () => {
                modal.style.display = 'none';
            };
        }

        // 1. CARGA INICIAL DE DATOS DE SESIÃ“N
        document.addEventListener('DOMContentLoaded', () => {
            const rol = sessionStorage.getItem('usuario_rol');
            const sucursal = sessionStorage.getItem('usuario_sucursal');
            const operador = sessionStorage.getItem('usuario_nombre');
            const inputSucursal = document.getElementById('sucursal_nombre');
            const inputOperador = document.getElementById('operador_nombre');

            if (!rol) {
                window.location.href = 'panel.html';
                return;
            }

            if (rol !== 'admin') {
                inputSucursal.value = sucursal;
                inputSucursal.readOnly = true; 
                inputSucursal.style.backgroundColor = '#e9ecef'; 
                inputSucursal.style.color = '#333';
            } else {
                inputSucursal.placeholder = "Ingresar Sucursal (Admin)";
            }

            if (operador) {
                inputOperador.value = operador;
            }
        });

        // 2. ENVÃO DEL FORMULARIO Y CONTROL DEL MODAL
        document.getElementById('formReservas').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const datos = {
                cliente_nombre: document.getElementById('cliente_nombre').value,
                cliente_telefono: document.getElementById('cliente_telefono').value,
                cliente_email: document.getElementById('cliente_email').value,
                prod_codigo: document.getElementById('prod_codigo').value,
                prod_cantidad: document.getElementById('prod_cantidad').value,
                sucursal_nombre: document.getElementById('sucursal_nombre').value,
                sucursal_contacto: document.getElementById('sucursal_contacto').value,
                operador_nombre: document.getElementById('operador_nombre').value,
                comentarios: document.getElementById('comentarios').value
            };

            fetch('/reservar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            })
            .then(res => {
                if (res.ok) {
                    // MOSTRAR EL MODAL EN LUGAR DEL CONFIRM
                    const modal = document.getElementById('miModal');
                    modal.style.display = 'flex';

                    // ACCIÃ“N AL HACER CLIC EN ACEPTAR
                    document.getElementById('modalAceptar').onclick = function() {
                        window.location.href = 'lista.html';
                    };

                    // ACCIÃ“N AL HACER CLIC EN CANCELAR
                    document.getElementById('modalCancelar').onclick = function() {
                        modal.style.display = 'none'; // Cerramos el modal
                        document.getElementById('formReservas').reset();
                        
                        // Restauramos datos fijos tras el reset
                        const rol = sessionStorage.getItem('usuario_rol');
                        if (rol !== 'admin') {
                            document.getElementById('sucursal_nombre').value = sessionStorage.getItem('usuario_sucursal');
                        }
                        document.getElementById('operador_nombre').value = sessionStorage.getItem('usuario_nombre');
                    };

                } else {
                    mostrarError('No se pudo guardar la reserva. Verifique los datos.');
                }
            })
            .catch(err => {
                mostrarError('âŒ ' + data.message);
            });
        });
    </script>
    
        <div id="modalError" class="modal-overlay">
            <div class="modal-caja" style="border-color: #f38ba8;">
                <h3 style="color: #f38ba8;">âŒ Error</h3>
                <p id="mensajeErrorTexto">Hubo un problema al procesar la solicitud.</p>
                <div class="modal-botones">
                    <button id="btnCerrarError" class="btn-azul" style="background-color: #f38ba8;">Aceptar</button>
                </div>
            </div>
        </div>
</body>
</html>