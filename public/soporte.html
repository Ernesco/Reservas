<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Box - Soporte TÃ©cnico</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo-texto">ğŸ› ï¸ Soporte TÃ©cnico</div>
        <a href="panel.html" class="btn-header">ğŸ  VOLVER</a>
    </header>

    <main class="contenedor-lista" style="background: white; max-width: 700px; margin: auto; padding: 5px;border-radius: 6px;">
        <div style="margin-bottom: 30px; border-bottom: 1px solid #45475a; padding-bottom: 20px;">
            <h2 style="color: #1e1e2e;">Â¿CÃ³mo podemos ayudarte?</h2>
            <p style="color: #8b92ae; line-height: 1.6;">
                1. SeleccionÃ¡ el <b>motivo</b> de tu contacto.<br>
                2. VerificÃ¡ que el <b>sector de origen</b> sea correcto.<br>
                3. DescribÃ­ el problema con la mayor claridad posible.<br>
                4. Si es una falla, podÃ©s adjuntar una <b>captura de pantalla</b>.
            </p>
        </div>

        <form id="formSoporte">
            <div class="fila-form">
                <label>ğŸ“ Sector de Origen (Detectado):</label>
                <input type="text" id="sectorOrigen" readonly style="background: #1e1e2e; color: #a6e3a1; font-weight: bold;">
            </div>

            <div class="fila-form" style="margin-top: 20px;">
                <label>â“ Motivo del contacto:</label>
                <select id="tipoTicket" style="width: 100%; padding: 12px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px;">
                    <option value="Falla de Sistema">âŒ Reportar una Falla / Error</option>
                    <option value="Sugerencia">ğŸ’¡ Sugerencia de mejora</option>
                    <option value="Pedido de ModificaciÃ³n">ğŸ“ Pedido de ModificaciÃ³n</option>
                    <option value="Consulta General">â“ Consulta General</option>
                </select>
            </div>

            <div class="fila-form" style="margin-top: 20px;">
                <label>ğŸ’¬ Comentario / DescripciÃ³n:</label>
                <textarea id="mensajeTicket" placeholder="EscribÃ­ aquÃ­ los detalles..." style="width: 100%; height: 120px; background: #313244; color: white; border: 1px solid #45475a; border-radius: 6px; padding: 12px; resize: none;"></textarea>
            </div>

            <div class="fila-form" style="margin-top: 20px;">
                <label>ğŸ–¼ï¸ Adjuntar Imagen (Opcional):</label>
                <input type="file" id="imagenSoporte" accept="image/*" style="color: #bac2de; margin-top: 10px;">
            </div>

            <button type="submit" class="btn-azul" style="width: 100%; margin-top: 30px; padding: 15px; font-size: 1.1em;">
                ğŸš€ ENVIAR TICKET DE SOPORTE
            </button>
        </form>
    </main>

    <div id="modalAviso" class="modal-overlay">
        <div class="modal-caja" id="bordeModal">
            <h3 id="tituloAviso"></h3>
            <p id="textoAviso"></p>
            <button onclick="window.history.back()" class="btn-azul" id="btnColorAviso">Aceptar y Volver</button>
        </div>
    </div>

    <script>
        // Cargar sector de origen
        document.getElementById('sectorOrigen').value = sessionStorage.getItem('origen_soporte') || 'Desconocido';

        document.getElementById('formSoporte').onsubmit = async function(e) {
            e.preventDefault();
            const usuario = sessionStorage.getItem('usuario_nombre') || 'Invitado';
            const sector = document.getElementById('sectorOrigen').value;
            const tipo = document.getElementById('tipoTicket').value;
            const mensaje = document.getElementById('mensajeTicket').value.trim();
            const inputImagen = document.getElementById('imagenSoporte');

            if (!mensaje) return alert("Por favor, ingresÃ¡ una descripciÃ³n.");

            // Convertimos la imagen a Base64 si existe
            let imagenBase64 = null;
            if (inputImagen.files[0]) {
                const reader = new FileReader();
                imagenBase64 = await new Promise(resolve => {
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(inputImagen.files[0]);
                });
            }

            // Enviamos al servidor
            fetch('/admin/soporte', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    tipo: `${tipo} (Desde: ${sector})`, 
                    mensaje, 
                    usuario,
                    imagen: imagenBase64 // El servidor recibirÃ¡ la imagen como texto largo
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarAviso('âœ… Enviado', 'El ticket fue enviado correctamente. Te responderemos a la brevedad.', false);
                }
            });
        };

        function mostrarAviso(t, m, err) {
            document.getElementById('tituloAviso').textContent = t;
            document.getElementById('textoAviso').textContent = m;
            document.getElementById('modalAviso').style.display = 'flex';
        }
    </script>
</body>
</html>