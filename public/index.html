<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">document.oncontextmenu = function(){return false;}</script>
    <title>Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <div class="logo-texto">INGRESO AL SISTEMA DE RESERVAS</div>
    </header>

    <main>
        <div class="caja-central">
            <h2>Iniciar Sesi√≥n</h2>
            <form id="formLogin">
                <label for="usuario">Usuario:</label>
                <input type="text" id="usuario" placeholder="Ej: admin" required>
                <label for="password">Contrase√±a:</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <button type="submit" class="btn-azul">INGRESAR</button>
                <p id="mensaje" style="margin-top: 15px; text-align: center; font-weight: bold;"></p>
            </form>
        </div>
    </main>

<footer>
    <div class="footer-creador-container">
        <span class="texto-creado">Creado por:</span>
        <img src="./img/New_Logo_OB.png" alt="One Box Logo" class="footer-logo">
    </div>

    <div class="footer-centro">
        <div class="footer-links">
            <a href="soporte.html" onclick="registrarOrigenSoporte()">Soporte</a>
        </div>
        <p>&copy; 2026 Tu Sistema de Reservas. Todos los derechos reservados.</p>
    </div>

    <div class="footer-version-container">
        <div class="footer-version">v4.5.0</div>
    </div>
</footer>

    <script>
        function registrarOrigenSoporte() {
            // Obtenemos el nombre del archivo actual (ej: login.html)
            const paginaActual = window.location.pathname.split('/').pop() || 'Inicio';
            sessionStorage.setItem('origen_soporte', paginaActual);
        }
    </script>

    <div id="modalSoporte" class="modal-overlay">
        <div class="modal-caja">
            <h3 style="color: #89b4fa;">üõ†Ô∏è Soporte T√©cnico</h3>
            <form id="formSoporte">
                <label style="color: #bac2de;">Tipo de solicitud:</label>
                <select id="tipo_ticket" required>
                    <option value="Falla">Reportar Falla</option>
                    <option value="Modificacion">Solicitar Modificaci√≥n</option>
                    <option value="Sugerencia">Sugerencia</option>
                </select>
                <label style="color: #bac2de; margin-top: 10px;">Descripci√≥n detallada:</label>
                <textarea id="desc_ticket" required placeholder="Describe el problema o sugerencia..."></textarea>
                <div class="modal-botones">
                    <button type="submit" class="btn-azul">ENVIAR TICKET</button>
                    <button type="button" onclick="cerrarSoporte()" class="btn-secundario">CANCELAR</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalAviso" class="modal-overlay">
        <div class="modal-caja" id="bordeModal">
            <h3 id="tituloAviso"></h3>
            <p id="textoAviso" style="color: #fff; margin-bottom: 20px;"></p>
            <div class="modal-botones">
                <button onclick="cerrarAviso()" class="btn-azul" id="btnColorAviso">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        // --- GESTI√ìN DE AVISOS Y MODALES ---
        function mostrarAviso(titulo, mensaje, esError = true) {
            const modal = document.getElementById('modalAviso');
            const tituloH3 = document.getElementById('tituloAviso');
            const textoP = document.getElementById('textoAviso');
            const borde = document.getElementById('bordeModal');
            const btn = document.getElementById('btnColorAviso');

            tituloH3.textContent = titulo;
            textoP.textContent = mensaje;
            
            const color = esError ? '#f38ba8' : '#a6e3a1';
            tituloH3.style.color = color;
            borde.style.borderColor = color;
            btn.style.backgroundColor = color;

            modal.style.display = 'flex';
        }

        function cerrarAviso() { document.getElementById('modalAviso').style.display = 'none'; }
        function abrirSoporte() { document.getElementById('modalSoporte').style.display = 'flex'; }
        function cerrarSoporte() { document.getElementById('modalSoporte').style.display = 'none'; }

        // --- L√ìGICA DE LOGIN ---
        document.getElementById('formLogin').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Feedback visual: Cambiamos el bot√≥n al iniciar la petici√≥n
            const btn = e.target.querySelector('button');
            const textoOriginal = btn.textContent;
            
            btn.textContent = 'VERIFICANDO...';
            btn.disabled = true;
            btn.style.opacity = '0.7';

            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.setItem('usuario_nombre', data.nombre);
                    sessionStorage.setItem('usuario_rol', data.rol);
                    sessionStorage.setItem('usuario_sucursal', data.sucursal);
                    window.location.href = 'panel.html';
                } else {
                    // Restauramos el bot√≥n si el login falla
                    btn.textContent = textoOriginal;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    mostrarAviso('‚ùå Error', data.message, true);
                }
            })
            .catch(() => {
                // Restauramos el bot√≥n si hay error de red
                btn.textContent = textoOriginal;
                btn.disabled = false;
                btn.style.opacity = '1';
                mostrarAviso('‚ùå Error', 'Error de conexi√≥n con el servidor', true);
            });
        });

        // --- ENV√çO DE SOPORTE ---
        document.getElementById('formSoporte').addEventListener('submit', async function(e) {
            e.preventDefault();
            const datos = {
                tipo: document.getElementById('tipo_ticket').value,
                descripcion: document.getElementById('desc_ticket').value,
                usuario: sessionStorage.getItem('usuario_nombre') || 'Invitado'
            };
            try {
                const res = await fetch('/enviar-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if (res.ok) {
                    cerrarSoporte();
                    this.reset();
                    mostrarAviso('‚úÖ Enviado', 'Ticket recibido correctamente.', false);
                } else {
                    mostrarAviso('‚ùå Error', 'No se pudo enviar el ticket.', true);
                }
            } catch {
                mostrarAviso('‚ùå Error', 'Falla de red.', true);
            }
        });
    </script>
</body>
</html>