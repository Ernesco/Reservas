<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">document.oncontextmenu = function(){return false;}</script>
    <title>Reservas - Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <div class="logo-texto">INGRESO AL SISTEMA DE RESERVAS</div>
    </header>

    <div class="caja-central">
        <h2>Iniciar Sesi√≥n</h2>
        <form id="formLogin">
            <label for="usuario">Usuario:</label>
            <input type="text" id="usuario" placeholder="Ej: admin" required>
            
            <label for="password">Contrase√±a:</label>
            <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            
            <button type="submit" class="btn-azul">INGRESAR</button>
            
            <p id="mensaje" style="margin-top: 15px; text-align: center; font-weight: bold;"></p>
        </form>
    </div>

    <footer>
        <div class="footer-contenido">
            <img src="./img/Rl_Logo.png" alt="Logo Footer" class="footer-logo">
            <p>&copy; 2026 Tu Sistema de Reservas. Todos los derechos reservados.</p>
            <div class="footer-links">
                <a href="javascript:void(0)" onclick="abrirSoporte()">Soporte</a>
            </div>
        </div>
    </footer>

    <div id="modalSoporte" class="modal-overlay">
        <div class="modal-caja">
            <h3 style="color: #4a90e2;">üõ†Ô∏è Soporte T√©cnico</h3>
            <form id="formSoporte" style="width: 100%;">
                <label style="color: #5e616b;">Tipo de solicitud:</label>
                <select id="tipo_ticket" required>
                    <option value="Falla">Reportar Falla</option>
                    <option value="Modificacion">Solicitar Modificaci√≥n</option>
                    <option value="Sugerencia">Sugerencia</option>
                </select>
                
                <label style="color: #5e616b;">Descripci√≥n:</label>
                <textarea id="desc_ticket" required placeholder="Describe el problema o sugerencia..." style="width: 100%; height: 80px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px;"></textarea>
                
                <div class="modal-botones">
                    <button type="submit" class="btn-azul">ENVIAR TICKET</button>
                    <button type="button" onclick="cerrarSoporte()" class="btn-secundario">CANCELAR</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalError" class="modal-overlay">
        <div class="modal-caja" style="border-color: #f38ba8;">
            <h3 style="color: #f38ba8;">‚ùå Error</h3>
            <p id="mensajeErrorTexto">Hubo un problema al procesar la solicitud.</p>
            <div class="modal-botones">
                <button id="btnCerrarError" class="btn-azul" style="background-color: #f38ba8;">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        // --- L√ìGICA DE LOGIN ---
        function mostrarError(mensaje) {
            const modal = document.getElementById('modalError');
            const texto = document.getElementById('mensajeErrorTexto');
            const btnCerrar = document.getElementById('btnCerrarError');

            texto.textContent = mensaje;
            modal.style.display = 'flex';

            btnCerrar.onclick = () => {
                modal.style.display = 'none';
            };
        }

        document.getElementById('formLogin').addEventListener('submit', function(e) {
            e.preventDefault();
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const mensaje = document.getElementById('mensaje');

            mensaje.style.color = '#4a90e2';
            mensaje.textContent = 'Verificando...';

            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.setItem('usuario_rol', data.rol);
                    sessionStorage.setItem('usuario_sucursal', data.sucursal);
                    sessionStorage.setItem('usuario_nombre', data.nombre);

                    mensaje.style.color = '#28a745';
                    mensaje.textContent = '¬°Bienvenido! Entrando...';

                    setTimeout(() => {
                        window.location.href = 'panel.html';
                    }, 500);
                } else {
                    mostrarError(data.message);
                    mensaje.textContent = '';
                }
            })
            .catch(err => {
                mostrarError('Error de conexi√≥n con el servidor');
                mensaje.textContent = '';
            });
        });

        // --- L√ìGICA DE SOPORTE ---
        function abrirSoporte() {
            document.getElementById('modalSoporte').style.display = 'flex';
        }

        function cerrarSoporte() {
            document.getElementById('modalSoporte').style.display = 'none';
        }

        document.getElementById('formSoporte').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const datos = {
                tipo: document.getElementById('tipo_ticket').value,
                descripcion: document.getElementById('desc_ticket').value,
                usuario: sessionStorage.getItem('usuario_nombre') || 'Usuario no logueado'
            };

            try {
                const response = await fetch('/enviar-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                if (response.ok) {
                    alert("‚úÖ Ticket enviado con √©xito. Revisaremos tu solicitud pronto.");
                    cerrarSoporte();
                    this.reset();
                } else {
                    alert("‚ùå Error al enviar el ticket.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("‚ùå Error de red al intentar enviar el ticket.");
            }
        });
    </script>
</body>
</html>